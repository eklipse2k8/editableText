(function(b){b.editableText=function(){return this.init.apply(this,arguments)};b.editableText.prototype={element:null,options:null,buttons:null,editButton:null,value:null,converter:null,useMarkdown:null,init:function(a,c){var d=this;this.element=b(a);this.options=c;this.useMarkdown=c.enableMarkdown&&window.Showdown&&this.element.data("markdown")!=null;this.edit=b.proxy(this.edit,this);this.save=b.proxy(this.save,this);this.cancel=b.proxy(this.cancel,this);this.value=this.element.html();if(this.useMarkdown)this.converter=
new Showdown.converter,this._setContent(this.value);if(c.showToolbar==="after"||c.showToolbar==="before")this.buttons=b("<div>",{"class":"editableToolbar"}),c.showEdit&&this.buttons.append(b("<a>",{"class":"edit",href:"#",role:"button",title:c.editTitle})),c.showSave&&this.buttons.append(b("<a>",{"class":"save",href:"#",role:"button",title:c.saveTitle})),c.showCancel&&this.buttons.append(b("<a>",{"class":"cancel",href:"#",role:"button",title:c.cancelTitle})),this.element[c.showToolbar](this.buttons),
this.buttons.css({zIndex:(parseInt(this.element.css("zIndex"),10)||0)+1}),c.compensateTopMargin&&this.buttons.css({"margin-top":this.element.css("margin-top")}),this.buttons.children().hide(),this.editButton=this.buttons.find(".edit").click(this.edit).show(),this.buttons.find(".save").click(this.save),this.buttons.find(".cancel").click(this.cancel);this.element.keydown(function(a){a.keyCode===13&&!c.newlinesEnabled&&d.save(a);a.keyCode===27&&d.cancel(a)});c.editOnDblClick&&this.element.dblclick(this.edit);
this.element.attr("contenteditable")==null&&this.element.attr("contenteditable","false")},edit:function(a){this.element.attr("contenteditable")!=="true"&&(a&&a.preventDefault(),this._startEditing(),this.useMarkdown&&this.element.html(this.value))},save:function(a){if(this.element.attr("contenteditable")==="true"){a&&a.preventDefault();a&&a.stopImmediatePropagation();this._stopEditing();a=this.value;this.value=this.element.html();this._setContent(this.value);if(!this.options.newlinesEnabled&&this.value.match(/<br>$/))this.value=
this.value.substr(0,this.value.length-4);b.isFunction(this.options.change)&&this.options.change.call(this.element[0],this.value,a);this.element.trigger("change",[this.value,a])}},cancel:function(a){this.element.attr("contenteditable")==="true"&&(a&&a.preventDefault(),a&&a.stopImmediatePropagation(),this._stopEditing(),this._setContent(this.value))},_startEditing:function(){this.options.showToolbar&&(this.buttons.children().show(),this.editButton.hide());this.element.attr("contenteditable","true").focus();
this.options.saveOnBlur&&b(document).bind("click",b.proxy(this._saveOnClickOutside,this));b.isFunction(this.options.startEditing)&&this.options.startEditing.call(this.element[0]);this.element.trigger("startEditing")},_stopEditing:function(){this.options.showToolbar&&(this.buttons.children().hide(),this.editButton.show());this.element.attr("contenteditable","false");this.options.saveOnBlur&&b(document).unbind("click",this.saveOnClickOutside);this.element.blur();b.isFunction(this.options.stopEditing)&&
this.options.stopEditing.call(this.element[0]);this.element.trigger("stopEditing")},_setContent:function(a){this.useMarkdown?this.element.html(this.converter.makeHtml(a.replace(/<br>/gi,"\n"))):this.element.html(a)},_saveOnClickOutside:function(a){var c=b(a.target);!c.closest(this.element).length&&!c.closest(this.buttons).length&&this.save(a)}};b.fn.editableText=function(a){var c=Array.prototype.slice.call(arguments,1);return this.each(function(){var d=b.data(this,"$.editableText");if(d)if(typeof a===
"string"&&a[0]!=="_"&&b.isFunction(d[a]))d[a].apply(d,c);else throw console&&console.warn('$.editableText "%o" does not have a (public) method "%o".',d,a),Error('$.editableText "'+d+'" does not have a (public) method "'+a+'".');else a=b.extend({},b.fn.editableText.defaults,a),b.data(this,"$.editableText",new b.editableText(this,a))})};b.fn.editableText.defaults={enableMarkdown:!0,newlinesEnabled:!1,showToolbar:"before",showCancel:!0,showEdit:!0,showSave:!0,compensateTopMargin:!0,editTitle:"Edit",
saveTitle:"Save",cancelTitle:"Discard",editOnDblClick:!0,saveOnBlur:!0,change:null,startEditing:null,stopEditing:null}})(jQuery);
